version: 2.1

# Optimized CircleCI pipeline for Dockerized Rust Portfolio
executors:
  docker-executor:
    docker:
      - image: cimg/base:current
    resource_class: medium
    environment:
      DOCKER_BUILDKIT: 1

jobs:
  # Build and test the Docker image
  build-and-test:
    executor: docker-executor
    steps:
      - checkout
      - setup_remote_docker:
          version: 24.0.9
          docker_layer_caching: true
      
      - run:
          name: Build Docker image
          command: |
            echo "üê≥ Building portfolio Docker image..."
            docker build -t portfolio-app:${CIRCLE_SHA1} .
            docker tag portfolio-app:${CIRCLE_SHA1} portfolio-app:latest
            
            # Show image info
            docker images portfolio-app
            echo "‚úÖ Docker image built successfully"
      
      - run:
          name: Test Docker image
          command: |
            echo "üß™ Testing Docker image..."
            
            # Start container in background
            docker run -d --name test-portfolio -p 8000:8000 portfolio-app:latest
            
            # Wait for container to be ready
            echo "‚è≥ Waiting for container to be ready..."
            i=1
            while [ $i -le 30 ]; do
              if docker exec test-portfolio wget --no-verbose --tries=1 --spider http://localhost:8000/health 2>/dev/null; then
                echo "‚úÖ Container is healthy!"
                break
              fi
              if [ $i -eq 30 ]; then
                echo "‚ùå Container failed to become healthy"
                docker logs test-portfolio
                exit 1
              fi
              sleep 2
              i=$((i + 1))
            done
            
            # Test health endpoint
            docker exec test-portfolio wget -q -O- http://localhost:8000/health
            echo "‚úÖ Health check passed"
            
            # Test homepage (should return content)
            HOMEPAGE_SIZE=$(docker exec test-portfolio wget -q -O- http://localhost:8000 | wc -c)
            if [ "$HOMEPAGE_SIZE" -gt 1000 ]; then
              echo "‚úÖ Homepage test passed (${HOMEPAGE_SIZE} bytes)"
            else
              echo "‚ùå Homepage test failed (${HOMEPAGE_SIZE} bytes)"
              exit 1
            fi
            
            # Show container stats
            echo "üìä Container stats:"
            docker stats --no-stream test-portfolio
            
            # Cleanup
            docker stop test-portfolio
            docker rm test-portfolio
      
      - run:
          name: Save Docker image for deployment
          command: |
            echo "üíæ Saving Docker image..."
            docker save portfolio-app:latest | gzip > portfolio-app.tar.gz
            ls -lh portfolio-app.tar.gz
      
      - persist_to_workspace:
          root: .
          paths:
            - portfolio-app.tar.gz

  # Deploy to production server
  deploy-production:
    executor: docker-executor
    steps:
      - checkout
      - attach_workspace:
          at: .
      - add_ssh_keys:
          fingerprints:
            - "SHA256:XUKEgesVvQ7EG6ERyVsv/PnQ21/qSbQNvQN1GR47N7c"
      
      - run:
          name: Deploy to OCI server
          command: |
            echo "üöÄ Starting deployment to production server..."
            
            # Server details
            SERVER_HOST="129.80.244.212"
            SERVER_USER="ubuntu"
            
            # Transfer Docker image
            echo "üì§ Transferring Docker image..."
            scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
                portfolio-app.tar.gz ${SERVER_USER}@${SERVER_HOST}:/tmp/
            
            echo "üèÉ Executing deployment on server..."
            ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
                ${SERVER_USER}@${SERVER_HOST} << 'DEPLOY_SCRIPT'
              
              set -e
              
              log() {
                echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1"
              }
              
              log "üöÄ Starting deployment process..."
              
              # Load new Docker image
              log "üì¶ Loading new Docker image..."
              docker load < /tmp/portfolio-app.tar.gz
              
              # Create backup of current deployment
              if docker ps --format "table {{.Names}}" | grep -q portfolio-app; then
                log "üíæ Creating backup of current deployment..."
                mkdir -p /opt/portfolio/backups/$(date +%Y%m%d_%H%M%S)
                docker save portfolio-app:latest | gzip > /opt/portfolio/backups/$(date +%Y%m%d_%H%M%S)/portfolio-backup.tar.gz 2>/dev/null || true
              fi
              
              # Stop existing container
              log "üõë Stopping existing container..."
              docker stop portfolio-app 2>/dev/null || true
              docker rm portfolio-app 2>/dev/null || true
              
              # Start new container
              log "üê≥ Starting new container..."
              docker run -d \
                --name portfolio-app \
                --restart unless-stopped \
                -p 127.0.0.1:8000:8000 \
                --health-cmd="wget --no-verbose --tries=1 --spider http://localhost:8000/health || exit 1" \
                --health-interval=30s \
                --health-timeout=10s \
                --health-retries=3 \
                --log-driver=json-file \
                --log-opt max-size=10m \
                --log-opt max-file=3 \
                portfolio-app:latest
              
              # Wait for container to be healthy
              log "‚è≥ Waiting for container to be healthy..."
              i=1
              while [ $i -le 60 ]; do
                HEALTH=$(docker inspect --format='{{.State.Health.Status}}' portfolio-app 2>/dev/null || echo "starting")
                if [ "$HEALTH" = "healthy" ]; then
                  log "‚úÖ Container is healthy!"
                  break
                fi
                if [ $i -eq 60 ]; then
                  log "‚ùå Container failed to become healthy after 2 minutes"
                  docker logs --tail 20 portfolio-app
                  exit 1
                fi
                log "Container health status: $HEALTH (attempt $i/60)"
                sleep 2
                i=$((i + 1))
              done
              
              # Test application directly
              log "üß™ Testing application..."
              if docker exec portfolio-app wget --no-verbose --tries=1 --spider http://localhost:8000/health; then
                log "‚úÖ Direct health check passed"
              else
                log "‚ùå Direct health check failed"
                docker logs --tail 20 portfolio-app
                exit 1
              fi
              
              # Test through Nginx proxy
              if curl -f http://localhost/health >/dev/null 2>&1; then
                log "‚úÖ Nginx proxy test passed"
              else
                log "‚ùå Nginx proxy test failed"
                sudo systemctl status nginx --no-pager
                exit 1
              fi
              
              # Test homepage content
              HOMEPAGE_SIZE=$(curl -s http://localhost/ | wc -c)
              if [ "$HOMEPAGE_SIZE" -gt 1000 ]; then
                log "‚úÖ Homepage test passed (${HOMEPAGE_SIZE} bytes)"
              else
                log "‚ùå Homepage test failed (${HOMEPAGE_SIZE} bytes)"
                exit 1
              fi
              
              # Cleanup
              log "üßπ Cleaning up..."
              rm -f /tmp/portfolio-app.tar.gz
              
              # Cleanup old Docker images (keep last 3)
              docker image prune -f >/dev/null 2>&1 || true
              OLD_IMAGES=$(docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.ID}}" | grep portfolio-app | tail -n +4 | awk '{print $3}')
              if [ -n "$OLD_IMAGES" ]; then
                echo "$OLD_IMAGES" | xargs docker rmi >/dev/null 2>&1 || true
                log "üóëÔ∏è  Cleaned up old Docker images"
              fi
              
              # Show final status
              log "üìä Deployment status:"
              docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep portfolio-app
              
              log "üéâ Deployment completed successfully!"
              log "üåê Portfolio is live at: http://129.80.244.212"
              
            DEPLOY_SCRIPT
            
            echo "‚úÖ Deployment completed successfully!"
            echo ""
            echo "üåê Portfolio URLs:"
            echo "  ‚Ä¢ Production: http://129.80.244.212"
            echo "  ‚Ä¢ Health check: http://129.80.244.212/health"
            echo ""
            echo "üìä Deployment summary:"
            echo "  ‚Ä¢ Image: portfolio-app:latest"
            echo "  ‚Ä¢ Container: portfolio-app"
            echo "  ‚Ä¢ Server: ${SERVER_HOST}"
            echo "  ‚Ä¢ Status: ‚úÖ Live"

  # Health check job (can be run independently)
  health-check:
    executor: docker-executor
    steps:
      - run:
          name: Check production health
          command: |
            echo "üè• Checking production server health..."
            
            SERVER_URL="http://129.80.244.212"
            
            # Check health endpoint
            if curl -f -s "${SERVER_URL}/health" -o /dev/null; then
              echo "‚úÖ Health check passed"
              curl -s "${SERVER_URL}/health" | jq . 2>/dev/null || curl -s "${SERVER_URL}/health"
            else
              echo "‚ùå Health check failed"
              exit 1
            fi
            
            # Check homepage
            HOMEPAGE_SIZE=$(curl -s "${SERVER_URL}/" | wc -c)
            if [ "$HOMEPAGE_SIZE" -gt 1000 ]; then
              echo "‚úÖ Homepage check passed (${HOMEPAGE_SIZE} bytes)"
            else
              echo "‚ùå Homepage check failed (${HOMEPAGE_SIZE} bytes)"
              exit 1
            fi
            
            echo "üéâ All health checks passed!"

# Workflows
workflows:
  # Main deployment workflow
  build-and-deploy:
    jobs:
      - build-and-test:
          filters:
            branches:
              ignore: /^dependabot\/.*/
      
      - deploy-production:
          requires:
            - build-and-test
          filters:
            branches:
              only:
                - master
                - main
          context: production-deploy
      
      - health-check:
          requires:
            - deploy-production
          filters:
            branches:
              only:
                - master
                - main

  # Scheduled health checks (every 6 hours)
  scheduled-health-check:
    triggers:
      - schedule:
          cron: "0 */6 * * *"
          filters:
            branches:
              only: main
    jobs:
      - health-check

  # Weekly dependency and security check
  weekly-maintenance:
    triggers:
      - schedule:
          cron: "0 2 * * 1"  # Monday at 2 AM
          filters:
            branches:
              only: main
    jobs:
      - build-and-test